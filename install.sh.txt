#!/bin/bash



# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#–í–≤–µ—Å—Ç–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
DB_USER=""

#–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
DB_PASSWORD=""

DB_NAME="project"

GIT_REPO="https://github.com/z1503/innoproject-manager.git"

PROJECT_DIR="/var/www/html/project"

APACHE_CONF="/etc/apache2/sites-available/project.conf"

#–í–≤–µ—Å—Ç–∏ –¥–æ–º–µ–Ω(project.z-zhr.ru)
DOMAIN=""



echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."



# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤..."

sudo apt update && sudo apt upgrade -y

sudo apt install -y apache2 php php-mysql unzip git mysql-server



# 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."

if [ -d "$PROJECT_DIR" ]; then

  sudo rm -rf "$PROJECT_DIR"

fi

sudo git clone "$GIT_REPO" "$PROJECT_DIR"



# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

echo "üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MySQL..."

sudo mysql -u root -e "DROP DATABASE IF EXISTS $DB_NAME;"

sudo mysql -u root -e "CREATE DATABASE $DB_NAME;"

sudo mysql -u root -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"

sudo mysql -u root -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"

sudo mysql -u root -e "FLUSH PRIVILEGES;"



# –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ kanban.sql

echo "üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

sudo mysql -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < "$PROJECT_DIR/db/kanban.sql"



# 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PHP (—Ñ–∞–π–ª —Ñ—É–Ω–∫—Ü–∏–π)

echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PHP..."

CONFIG_FILE="$PROJECT_DIR/db/functions.php"

sudo sed -i "s/\$host = .*/\$host = \"localhost\";/" "$CONFIG_FILE"

sudo sed -i "s/\$user = .*/\$user = \"$DB_USER\";/" "$CONFIG_FILE"

sudo sed -i "s/\$password = .*/\$password = \"$DB_PASSWORD\";/" "$CONFIG_FILE"

sudo sed -i "s/\$database = .*/\$database = \"$DB_NAME\";/" "$CONFIG_FILE"



# 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

sudo chown -R www-data:www-data "$PROJECT_DIR"

sudo chmod -R 755 "$PROJECT_DIR"



# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apache

echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Apache..."

echo "<VirtualHost *:80>

  ServerName $DOMAIN

  DocumentRoot $PROJECT_DIR



  <Directory $PROJECT_DIR>

      AllowOverride All

      Require all granted

  </Directory>



  ErrorLog \${APACHE_LOG_DIR}/project_error.log

  CustomLog \${APACHE_LOG_DIR}/project_access.log combined

</VirtualHost>" | sudo tee "$APACHE_CONF"



# 7. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Apache

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Apache..."

sudo a2ensite project

sudo systemctl restart apache2



echo "‚úÖ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://$DOMAIN"

